{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ discussion.title }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <a href="{% url 'course_discussions' discussion.course.id %}" 
                   class="inline-flex items-center text-blue-600 hover:text-blue-800">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to Discussions
                </a>
                {% if discussion.is_pinned %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                    <i class="fas fa-thumbtack mr-1"></i>Pinned
                </span>
                {% endif %}
            </div>
            
            <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ discussion.title }}</h1>
            <p class="text-gray-600 mb-4">{{ discussion.description }}</p>
            
            <div class="flex items-center text-sm text-gray-500">
                <i class="fas fa-user mr-1"></i>
                <span class="mr-4">{{ discussion.created_by.get_full_name|default:discussion.created_by.username }}</span>
                <i class="fas fa-calendar mr-1"></i>
                <span>{{ discussion.created_at|date:"M d, Y H:i" }}</span>
            </div>
        </div>

        <!-- Add New Post Form -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Add to Discussion</h3>
            <form method="post">
                {% csrf_token %}
                <div class="mb-4">
                    <textarea name="content" rows="4" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Share your thoughts..."></textarea>
                </div>
                <button type="submit" 
                        class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors">
                    <i class="fas fa-paper-plane mr-2"></i>
                    Post Reply
                </button>
            </form>
        </div>

        <!-- Posts -->
        <div class="space-y-6">
            {% for post in posts %}
            <div class="bg-white rounded-lg shadow-md" id="post-{{ post.id }}">
                <div class="p-6">
                    <div class="flex items-start space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                                <span class="text-white font-medium text-sm">
                                    {{ post.author.first_name|first|default:post.author.username|first }}{{ post.author.last_name|first }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-2">
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-900">
                                        {{ post.author.get_full_name|default:post.author.username }}
                                    </h4>
                                    <p class="text-xs text-gray-500">{{ post.created_at|date:"M d, Y H:i" }}</p>
                                </div>
                                
                                <button onclick="toggleReplyForm('{{ post.id }}')" 
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    <i class="fas fa-reply mr-1"></i>Reply
                                </button>
                            </div>
                            
                            <div class="text-gray-700 mb-4">{{ post.content|linebreaks }}</div>
                            
                            <!-- Reply Form (Hidden by default) -->
                            <div id="reply-form-{{ post.id }}" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" name="parent_id" value="{{ post.id }}">
                                    <div class="mb-3">
                                        <textarea name="content" rows="3" 
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                  placeholder="Write a reply..."></textarea>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button type="submit" 
                                                class="px-3 py-1 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 transition-colors">
                                            Reply
                                        </button>
                                        <button type="button" onclick="toggleReplyForm('{{ post.id }}')"
                                                class="px-3 py-1 bg-gray-300 text-gray-700 text-sm font-medium rounded hover:bg-gray-400 transition-colors">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Replies -->
                            {% if post.replies.exists %}
                            <div class="mt-4 pl-4 border-l-2 border-gray-200 space-y-4">
                                {% for reply in post.replies.all %}
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center">
                                            <span class="text-white font-medium text-xs">
                                                {{ reply.author.first_name|first|default:reply.author.username|first }}{{ reply.author.last_name|first }}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <h5 class="text-sm font-medium text-gray-900">
                                                {{ reply.author.get_full_name|default:reply.author.username }}
                                            </h5>
                                            <span class="text-xs text-gray-500">{{ reply.created_at|date:"M d, Y H:i" }}</span>
                                        </div>
                                        <div class="text-sm text-gray-700">{{ reply.content|linebreaks }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="bg-white rounded-lg shadow-md p-12">
                <div class="text-center">
                    <i class="fas fa-comment text-gray-400 text-6xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Posts Yet</h3>
                    <p class="text-gray-600">Be the first to contribute to this discussion!</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function toggleReplyForm(postId) {
    const form = document.getElementById('reply-form-' + postId);
    form.classList.toggle('hidden');
}
</script>
{% endblock %}
